from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from django.conf import settings
from email.mime.text import MIMEText
from email.header import Header
from email.utils import formataddr
import smtplib
import random

class SendVerificationCodeView(APIView):
    def get(self, request):
        code = str(random.randint(100000, 999999))
        try:
            # 中文標題與內容
            subject = str(Header("專題程式驗證碼", "utf-8"))
            body = f"您的驗證碼為: {code}"

            # MIMEText 使用 utf-8
            msg = MIMEText(body, "plain", "utf-8")
            msg["Subject"] = subject
            msg["From"] = formataddr((str(Header("專題系統", "utf-8")), settings.EMAIL_HOST_USER))
            msg["To"] = "s1411232069@ad1.nutc.edu.tw"

            # 連線 Gmail SMTP
            with smtplib.SMTP(settings.EMAIL_HOST, settings.EMAIL_PORT) as server:
                server.starttls()
                server.login(settings.EMAIL_HOST_USER, settings.EMAIL_HOST_PASSWORD)
                # 這裡傳 bytes 而不是 str
                server.sendmail(
                    settings.EMAIL_HOST_USER,
                    ["s1411232069@ad1.nutc.edu.tw"],
                    msg.as_bytes()
                )

            return Response({'message': '驗證碼已發送，請檢查垃圾郵件'}, status=status.HTTP_200_OK)

        except Exception as e:
            return Response({'error': f'發送失敗: {str(e)}'}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
